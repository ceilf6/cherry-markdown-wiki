<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdownç¼–è¾‘å™¨çœŸå®æ€§èƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-area {
            margin: 20px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
        }
        .results {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        .editor-test {
            margin: 30px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 15px;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .metric {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.running {
            background: #fff3e0;
            color: #f57c00;
        }
        .status.success {
            background: #e8f5e8;
            color: #388e3c;
        }
        .status.error {
            background: #ffebee;
            color: #d32f2f;
        }
        .final-results {
            background: #f0f8ff;
            border: 2px solid #1976d2;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f5f5f5;
            font-weight: bold;
        }
        .winner {
            background: #e8f5e8;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Markdownç¼–è¾‘å™¨çœŸå®æ€§èƒ½æµ‹è¯•</h1>
        <p>è¿™æ˜¯ä¸€ä¸ªåœ¨çœŸå®æµè§ˆå™¨ç¯å¢ƒä¸­ç›´æ¥æµ‹é‡ç¼–è¾‘å™¨æ€§èƒ½çš„æµ‹è¯•é¡µé¢</p>
        
        <div>
            <button onclick="startAllTests()">ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•</button>
            <button onclick="clearResults()">ğŸ§¹ æ¸…ç©ºç»“æœ</button>
            <button onclick="exportResults()">ğŸ“„ å¯¼å‡ºç»“æœ</button>
        </div>
        
        <div id="status" class="status"></div>
        <div id="overall-results" class="final-results" style="display:none;"></div>
        <div id="test-results"></div>
        <div id="test-area" class="test-area" style="display:none;"></div>
    </div>

    <script>
        // å…¨å±€localStorageä¿®å¤ - åœ¨ä»»ä½•ç¼–è¾‘å™¨åŠ è½½å‰å°±è®¾ç½®å¥½
        (function() {
            // åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„localStorageæ¨¡æ‹Ÿ
            const mockStorage = {
                _data: {},
                getItem: function(key) {
                    return this._data[key] || null;
                },
                setItem: function(key, value) {
                    this._data[key] = String(value);
                },
                removeItem: function(key) {
                    delete this._data[key];
                },
                clear: function() {
                    this._data = {};
                },
                get length() {
                    return Object.keys(this._data).length;
                },
                key: function(index) {
                    const keys = Object.keys(this._data);
                    return keys[index] || null;
                }
            };
            
            // å¦‚æœlocalStorageä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿç‰ˆæœ¬
            try {
                if (!window.localStorage) {
                    Object.defineProperty(window, 'localStorage', {
                        value: mockStorage,
                        writable: false,
                        enumerable: true,
                        configurable: false
                    });
                } else {
                    // æµ‹è¯•æ˜¯å¦å¯ä»¥è®¿é—®
                    window.localStorage.getItem('test');
                }
            } catch (e) {
                // localStorageè®¿é—®è¢«æ‹’ç»ï¼Œä½¿ç”¨æ¨¡æ‹Ÿç‰ˆæœ¬
                Object.defineProperty(window, 'localStorage', {
                    value: mockStorage,
                    writable: false,
                    enumerable: true,
                    configurable: false
                });
            }
            
            // åŒæ ·å¤„ç†sessionStorage
            try {
                if (!window.sessionStorage) {
                    Object.defineProperty(window, 'sessionStorage', {
                        value: mockStorage,
                        writable: false,
                        enumerable: true,
                        configurable: false
                    });
                } else {
                    window.sessionStorage.getItem('test');
                }
            } catch (e) {
                Object.defineProperty(window, 'sessionStorage', {
                    value: mockStorage,
                    writable: false,
                    enumerable: true,
                    configurable: false
                });
            }
            
            console.log('âœ… localStorage/sessionStorage å·²ä¿®å¤');
        })();

        // === é€šç”¨å·¥å…·ï¼šç­‰å¾…DOMç¨³å®šã€åŠ è½½èµ„æºï¼ˆæ”¯æŒå¤šJS/CSSï¼ŒJSé¡ºåºåŠ è½½ï¼‰ ===
        function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

        async function waitForStableDOM(el, timeout=8000, stableFrames=6){
            if(!el) throw new Error('waitForStableDOM: invalid element');
            return new Promise((resolve, reject) => {
                const start = performance.now();
                let last = el.innerHTML.length;
                let stable = 0;
                let rafId;
                const check = () => {
                    const len = el.innerHTML.length;
                    if(len === last) stable++; else { stable = 0; last = len; }
                    if(stable >= stableFrames) done();
                    else if(performance.now() - start > timeout) done('timeout');
                    else rafId = requestAnimationFrame(check);
                };
                const done = (err) => {
                    if(rafId) cancelAnimationFrame(rafId);
                    err ? reject(new Error(err)) : resolve();
                };
                rafId = requestAnimationFrame(check);
            });
        }

        function loadScript(src){
            return new Promise((resolve, reject)=>{
                const s = document.createElement('script');
                s.src = src;
                s.async = false;
                s.setAttribute('data-perf-injected','1');
                s.onload = () => resolve(s);
                s.onerror = () => reject(new Error('script load error: '+src));
                document.head.appendChild(s);
            });
        }
        function loadStyle(href){
            return new Promise((resolve)=>{
                const l = document.createElement('link');
                l.rel='stylesheet';
                l.href=href;
                l.setAttribute('data-perf-injected','1');
                l.onload = () => resolve(l);
                l.onerror = () => resolve(l); // CSSå¤±è´¥ä¸é˜»å¡
                document.head.appendChild(l);
            });
        }
        async function loadScriptsSequentially(urls=[]){
            const nodes=[];
            for(const u of (urls||[])){
                const n = await loadScript(u);
                nodes.push(n);
            }
            return nodes;
        }
        async function loadResources(cssUrls=[], jsUrls=[]){
            const cssNodes = await Promise.all((cssUrls||[]).map(loadStyle));
            const jsNodes = await loadScriptsSequentially(jsUrls||[]);
            return [...cssNodes, ...jsNodes];
        }
        function cleanupInjectedResources(){
            document.querySelectorAll('[data-perf-injected="1"]').forEach(n=>n.remove());
        }

        // æµ‹è¯•å†…å®¹
        const testContent = {
            small: `# å°æ–‡æ¡£æµ‹è¯•
è¿™æ˜¯ä¸€ä¸ªå°å‹æµ‹è¯•æ–‡æ¡£ã€‚

## åŸºç¡€åŠŸèƒ½
- åˆ—è¡¨é¡¹ 1
- åˆ—è¡¨é¡¹ 2
- åˆ—è¡¨é¡¹ 3

**ç²—ä½“** å’Œ *æ–œä½“* æ–‡æœ¬ã€‚

\`\`\`javascript
console.log('Hello World');
\`\`\`

> å¼•ç”¨å—æµ‹è¯•

| è¡¨æ ¼ | æµ‹è¯• |
|------|------|
| æ•°æ®1 | æ•°æ®2 |`,

            medium: `# ä¸­å‹æ–‡æ¡£æ€§èƒ½æµ‹è¯•

## ç®€ä»‹
è¿™æ˜¯ä¸€ä¸ªä¸­ç­‰å¤§å°çš„Markdownæ–‡æ¡£ï¼Œç”¨äºæµ‹è¯•ç¼–è¾‘å™¨çš„å®é™…æ¸²æŸ“æ€§èƒ½ã€‚

## å¤šçº§æ ‡é¢˜æµ‹è¯•
### ä¸‰çº§æ ‡é¢˜
#### å››çº§æ ‡é¢˜
##### äº”çº§æ ‡é¢˜
###### å…­çº§æ ‡é¢˜

## æ–‡æœ¬æ ¼å¼åŒ–
**ç²—ä½“æ–‡æœ¬**ã€*æ–œä½“æ–‡æœ¬*ã€~~åˆ é™¤çº¿~~ã€\`è¡Œå†…ä»£ç \`ã€**_ç²—æ–œä½“_**

## åˆ—è¡¨æµ‹è¯•
### æ— åºåˆ—è¡¨
- ä¸»è¦åŠŸèƒ½ç‚¹1
- ä¸»è¦åŠŸèƒ½ç‚¹2
  - å­åŠŸèƒ½ç‚¹2.1
  - å­åŠŸèƒ½ç‚¹2.2
    - æ·±å±‚åµŒå¥—2.2.1
- ä¸»è¦åŠŸèƒ½ç‚¹3

### æœ‰åºåˆ—è¡¨
1. ç¬¬ä¸€æ­¥æ“ä½œ
2. ç¬¬äºŒæ­¥æ“ä½œ
3. ç¬¬ä¸‰æ­¥æ“ä½œ
   1. å­æ­¥éª¤3.1
   2. å­æ­¥éª¤3.2

## ä»£ç å—æµ‹è¯•
\`\`\`javascript
// JavaScript ä»£ç ç¤ºä¾‹
function fibonacci(n) {
  if (n <= 1) return n;
  return fibonacci(n - 1) + fibonacci(n - 2);
}

for (let i = 0; i < 10; i++) {
  console.log(\`fibonacci(\${i}) = \${fibonacci(i)}\`);
}
\`\`\`

\`\`\`python
# Python ä»£ç ç¤ºä¾‹
def quicksort(arr):
    if len(arr) <= 1:
        return arr
    pivot = arr[len(arr) // 2]
    left = [x for x in arr if x < pivot]
    middle = [x for x in arr if x == pivot]
    right = [x for x in arr if x > pivot]
    return quicksort(left) + middle + quicksort(right)
\`\`\`

## è¡¨æ ¼æµ‹è¯•
| ç¼–è¾‘å™¨ | å¯åŠ¨é€Ÿåº¦ | æ¸²æŸ“æ€§èƒ½ | å†…å­˜å ç”¨ |
|--------|----------|----------|----------|
| Editor A | å¿« | ä¼˜ç§€ | ä¸­ç­‰ |
| Editor B | ä¸­ç­‰ | è‰¯å¥½ | è¾ƒé«˜ |
| Editor C | æ…¢ | ä¼˜ç§€ | è¾ƒä½ |

## å¼•ç”¨å’Œé“¾æ¥
> è¿™æ˜¯ä¸€ä¸ªå¤šè¡Œå¼•ç”¨å—ã€‚
> 
> åŒ…å«å¤šä¸ªæ®µè½çš„å¼•ç”¨å†…å®¹ã€‚
> > åµŒå¥—å¼•ç”¨ä¹Ÿéœ€è¦æµ‹è¯•ã€‚

[GitHubé“¾æ¥](https://github.com) å’Œ [æ–‡æ¡£é“¾æ¥](https://example.com)

---

## å›¾ç‰‡æµ‹è¯•
![æµ‹è¯•å›¾ç‰‡](https://via.placeholder.com/300x200.png)`,

            large: `# å¤§å‹æ–‡æ¡£æ€§èƒ½å‹åŠ›æµ‹è¯•

## æµ‹è¯•æ¦‚è¿°
è¿™æ˜¯ä¸€ä¸ªå¤§å‹Markdownæ–‡æ¡£ï¼ŒåŒ…å«å¤§é‡å†…å®¹ä»¥æµ‹è¯•ç¼–è¾‘å™¨åœ¨å¤„ç†å¤æ‚æ–‡æ¡£æ—¶çš„çœŸå®æ€§èƒ½è¡¨ç°ã€‚

${Array.from({length: 15}, (_, i) => `
## ç¬¬${i + 1}éƒ¨åˆ†ï¼šé‡å¤å†…å®¹æµ‹è¯•

### ${i + 1}.1 æ ‡é¢˜æµ‹è¯•
è¿™æ˜¯ç¬¬${i + 1}éƒ¨åˆ†çš„å†…å®¹ï¼Œç”¨äºæµ‹è¯•ç¼–è¾‘å™¨å¤„ç†å¤§é‡é‡å¤ç»“æ„çš„èƒ½åŠ›ã€‚

### ${i + 1}.2 åˆ—è¡¨æµ‹è¯•
${Array.from({length: 8}, (_, j) => `- åˆ—è¡¨é¡¹ ${i + 1}.${j + 1}: è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•åˆ—è¡¨é¡¹ï¼ŒåŒ…å«ä¸€äº›æè¿°æ–‡æœ¬`).join('\n')}

### ${i + 1}.3 ä»£ç å—æµ‹è¯•
\`\`\`javascript
// ä»£ç å— ${i + 1}
function test${i + 1}() {
  const data = Array.from({length: 50}, (_, k) => ({
    id: k,
    value: k * ${i + 1},
    description: 'Test item ' + k
  }));
  return data.filter(item => item.value > ${i * 5});
}
\`\`\`

### ${i + 1}.4 è¡¨æ ¼æµ‹è¯•
| ID | åç§° | æ•°å€¼ | çŠ¶æ€ |
|----|------|------|------|
${Array.from({length: 4}, (_, k) => `| ${k + 1} | é¡¹ç›®${i + 1}-${k + 1} | ${(i + 1) * (k + 1) * 100} | æ´»è·ƒ |`).join('\n')}

### ${i + 1}.5 å¼•ç”¨å—æµ‹è¯•
> å¼•ç”¨å— ${i + 1}: è¿™æ˜¯ç¬¬${i + 1}ä¸ªå¼•ç”¨å—ï¼Œç”¨äºæµ‹è¯•å¤§é‡å¼•ç”¨å†…å®¹çš„æ¸²æŸ“æ€§èƒ½ã€‚
> 
> å¤šè¡Œå¼•ç”¨å†…å®¹ï¼ŒåŒ…å«æ›´å¤šçš„æ–‡æœ¬ä¿¡æ¯ã€‚

---
`).join('')}

## æ€§èƒ½æµ‹è¯•æ€»ç»“
è¿™ä¸ªå¤§å‹æ–‡æ¡£åŒ…å«äº†ï¼š
- 15ä¸ªä¸»è¦éƒ¨åˆ†
- 75ä¸ªå­æ ‡é¢˜
- 120ä¸ªåˆ—è¡¨é¡¹
- 15ä¸ªä»£ç å—
- 15ä¸ªè¡¨æ ¼
- å¤§é‡çš„æ–‡æœ¬å†…å®¹

ç”¨äºå…¨é¢æµ‹è¯•Markdownç¼–è¾‘å™¨çš„çœŸå®æ€§èƒ½æé™ã€‚`
        };

        // ç¼–è¾‘å™¨é…ç½®ï¼ˆç»Ÿä¸€æœ€å°é…ç½® + UMD ä¾èµ–ï¼‰
        const editors = [
            {
                name: 'Cherry Markdown',
                version: '0.9.4',
                cssUrls: ['https://unpkg.com/cherry-markdown@0.9.4/dist/cherry-markdown.css'],
                jsUrls: ['https://unpkg.com/cherry-markdown@0.9.4/dist/cherry-markdown.min.js'],
                init: function(content) {
                    console.log('ğŸ’ åˆå§‹åŒ– Cherry Markdown...');
                    const container = document.getElementById('test-area');
                    const cherry = new Cherry({
                        id: 'test-area',
                        value: content,
                        model: 'previewOnly',
                        toolbars: { showToolbar: false },
                        engine: {
                            global: { urlProcessor: () => false },
                            syntax: { codeBlock: { theme: 'default' } }
                        },
                        editor: { theme: 'default' }
                    });
                    console.log('âœ… Cherry Markdown åˆå§‹åŒ–æˆåŠŸ');
                    const ready = waitForStableDOM(container);
                    return { instance: cherry, container, ready };
                },
                cleanup: function() {
                    const testArea = document.getElementById('test-area');
                    testArea.innerHTML = '';
                }
            },
            {
                name: 'Vditor',
                version: '3.11.1',
                cssUrls: ['https://unpkg.com/vditor@3.11.1/dist/index.css'],
                jsUrls: ['https://unpkg.com/vditor@3.11.1/dist/index.min.js'],
                init: function(content) {
                    console.log('ğŸ“ åˆå§‹åŒ– Vditor...');
                    const container = document.getElementById('test-area');
                    let resolveReady;
                    const ready = new Promise(r=>resolveReady=r);
                    const v = new Vditor('test-area', {
                        value: content,
                        mode: 'wysiwyg',
                        width: '100%',
                        height: 400,
                        cache: { enable: false },
                        toolbar: [],
                        after: () => resolveReady()
                    });
                    console.log('âœ… Vditor åˆå§‹åŒ–æˆåŠŸ');
                    return { instance: v, container, ready: ready.then(()=>waitForStableDOM(container)) };
                },
                cleanup: function() {
                    const testArea = document.getElementById('test-area');
                    testArea.innerHTML = '';
                }
            },
            {
                name: 'EasyMDE',
                version: '2.20.0',
                cssUrls: ['https://unpkg.com/easymde@2.20.0/dist/easymde.min.css'],
                jsUrls: ['https://unpkg.com/easymde@2.20.0/dist/easymde.min.js'],
                init: function(content) {
                    console.log('âœï¸ åˆå§‹åŒ– EasyMDE...');
                    const container = document.getElementById('test-area');
                    const textarea = document.createElement('textarea');
                    textarea.id = 'easymde-textarea';
                    container.appendChild(textarea);
                    const easyMDE = new EasyMDE({
                        element: textarea,
                        initialValue: content,
                        spellChecker: false,
                        autofocus: false,
                        status: false,
                        toolbar: false
                    });
                    console.log('âœ… EasyMDE åˆå§‹åŒ–æˆåŠŸ');
                    const target = () => container.querySelector('.CodeMirror') || container;
                    const ready = (async()=>{ await waitForStableDOM(target()); })();
                    return { instance: easyMDE, container, ready };
                },
                cleanup: function() {
                    const testArea = document.getElementById('test-area');
                    testArea.innerHTML = '';
                }
            },
            {
                name: 'ByteMD',
                version: '1.22.0',
                cssUrls: ['https://unpkg.com/@bytemd/core@1.22.0/dist/index.min.css'],
                jsUrls: [
                    'https://unpkg.com/@bytemd/core@1.22.0/dist/index.min.js',
                    'https://unpkg.com/@bytemd/plugin-gfm@1.22.0/dist/index.min.js'
                ],
                init: function(content) {
                    console.log('ğŸ“– åˆå§‹åŒ– ByteMD...');
                    const container = document.getElementById('test-area');
                    if (typeof bytemd === 'undefined' || !bytemd.Editor) throw new Error('ByteMD not loaded');
                    const plugins = (typeof bytemdPluginGfm === 'function') ? [bytemdPluginGfm()] : [];
                    const editor = new bytemd.Editor({
                        target: container,
                        props: { value: content, plugins }
                    });
                    console.log('âœ… ByteMD åˆå§‹åŒ–æˆåŠŸ');
                    const ready = waitForStableDOM(container);
                    return { instance: editor, container, ready };
                },
                cleanup: function() {
                    const testArea = document.getElementById('test-area');
                    testArea.innerHTML = '';
                }
            },
            {
                name: 'TOAST UI Editor',
                version: '3.2.2',
                cssUrls: ['https://uicdn.toast.com/editor/latest/toastui-editor.min.css'],
                jsUrls: ['https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js'],
                init: function(content) {
                    console.log('ğŸ åˆå§‹åŒ– TOAST UI Editor...');
                    const container = document.getElementById('test-area');
                    let resolveReady;
                    const ready = new Promise(r=>resolveReady=r);
                    if (typeof toastui === 'undefined' || !toastui.Editor) throw new Error('TOAST UI Editor not loaded');
                    const editor = new toastui.Editor({
                        el: container,
                        initialValue: content,
                        previewStyle: 'vertical',
                        height: '400px',
                        events: { load: () => resolveReady() }
                    });
                    console.log('âœ… TOAST UI Editor åˆå§‹åŒ–æˆåŠŸ');
                    return { instance: editor, container, ready: ready.then(()=>waitForStableDOM(container)) };
                },
                cleanup: function() {
                    const testArea = document.getElementById('test-area');
                    testArea.innerHTML = '';
                }
            },
            {
                name: 'Milkdown',
                version: '7.15.2',
                cssUrls: [
                    'https://unpkg.com/@milkdown/theme-nord@7.15.2/style.css'
                ],
                jsUrls: [
                    'https://unpkg.com/@milkdown/core@7.15.2/dist/index.umd.js',
                    'https://unpkg.com/@milkdown/preset-commonmark@7.15.2/dist/index.umd.js',
                    'https://unpkg.com/@milkdown/theme-nord@7.15.2/dist/index.umd.js'
                ],
                init: function(content) {
                    console.log('ğŸ¥› åˆå§‹åŒ– Milkdown...');
                    const container = document.getElementById('test-area');
                    const root = document.createElement('div');
                    container.appendChild(root);
                    if (typeof Milkdown === 'undefined' || !Milkdown.Editor) throw new Error('Milkdown not loaded');

                    const ready = (async()=>{
                        await Milkdown.Editor
                            .make()
                            .config((ctx)=>{
                                ctx.set(Milkdown.rootCtx, root);
                            })
                            .use(MilkdownPresetCommonmark.commonmark)
                            .use(MilkdownThemeNord.nord)
                            .create();
                        await waitForStableDOM(root);
                    })();

                    console.log('âœ… Milkdown åˆå§‹åŒ–æˆåŠŸ');
                    return { instance: null, container: root, ready };
                },
                cleanup: function() {
                    const testArea = document.getElementById('test-area');
                    testArea.innerHTML = '';
                }
            }
        ];

        let allResults = {};
        let currentTestIndex = 0;

        // æµ‹è¯•å•ä¸ªç¼–è¾‘å™¨
        async function testEditor(editor, contentSize, content) {
            const testArea = document.getElementById('test-area');
            testArea.style.display = 'block';
            
            updateStatus(`æ­£åœ¨æµ‹è¯• ${editor.name} - ${contentSize} æ–‡æ¡£ (${content.length} å­—ç¬¦)...`, 'running');
            
            try {
                // æ¸…ç†æµ‹è¯•åŒºåŸŸä¸å†å²èµ„æº
                testArea.innerHTML = '';
                cleanupInjectedResources();

                const startTime = performance.now();

                // åŠ è½½èµ„æºï¼ˆæ”¯æŒå¤šJS/CSSï¼›JSé¡ºåºåŠ è½½ï¼‰
                const loadStartTime = performance.now();
                await loadResources(editor.cssUrls, editor.jsUrls);
                const loadEndTime = performance.now();
                const loadTime = loadEndTime - loadStartTime;

                // åˆå§‹åŒ–ï¼ˆready -> DOM ç¨³å®šï¼‰
                const initStartTime = performance.now();
                const { instance, container, ready } = editor.init(content);
                if (ready && typeof ready.then === 'function') {
                    await ready;
                } else {
                    await waitForStableDOM(container || testArea);
                }
                const readyEndTime = performance.now();

                const startupTime = readyEndTime - initStartTime;
                const totalTime = readyEndTime - startTime;

                // è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
                let memoryUsed = 0;
                if (performance.memory) {
                    memoryUsed = performance.memory.usedJSHeapSize / 1024 / 1024;
                }

                // æ¸…ç†å®ä¾‹ä¸èµ„æº
                if (editor.cleanup) {
                    editor.cleanup();
                }
                cleanupInjectedResources();

                const result = {
                    loadTime: Math.round(loadTime * 100) / 100,
                    startupTime: Math.round(startupTime * 100) / 100,
                    totalTime: Math.round(totalTime * 100) / 100,
                    memoryUsed: Math.round(memoryUsed * 100) / 100,
                    contentLength: content.length,
                    success: true
                };
                
                updateStatus(`âœ… ${editor.name} - ${contentSize} æµ‹è¯•æˆåŠŸ`, 'success');
                console.log(`${editor.name} ${contentSize} ç»“æœ:`, result);
                return result;
                
            } catch (error) {
                updateStatus(`âŒ ${editor.name} - ${contentSize} æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(`${editor.name} ${contentSize} é”™è¯¯:`, error);
                return {
                    error: error.message,
                    contentLength: content.length,
                    success: false
                };
            } finally {
                testArea.style.display = 'none';
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // æ˜¾ç¤ºå•ä¸ªç¼–è¾‘å™¨ç»“æœ
        function displayEditorResult(editorName, results) {
            const resultsDiv = document.getElementById('test-results');
            
            const editorDiv = document.createElement('div');
            editorDiv.className = 'editor-test';
            editorDiv.innerHTML = `
                <h3>ğŸ“¦ ${editorName}</h3>
                <div class="metrics">
                    ${Object.entries(results).map(([size, result]) => {
                        if (result.success) {
                            return `
                                <div class="metric">
                                    <div class="metric-value">${result.loadTime}ms</div>
                                    <div class="metric-label">${size} èµ„æºåŠ è½½</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value">${result.startupTime}ms</div>
                                    <div class="metric-label">${size} å¯åŠ¨(è‡³å¯è§)</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value">${result.totalTime}ms</div>
                                    <div class="metric-label">${size} æ€»æ—¶é—´</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value">${result.memoryUsed}MB</div>
                                    <div class="metric-label">${size} å†…å­˜</div>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="metric">
                                    <div class="metric-value">ERROR</div>
                                    <div class="metric-label">${size} - ${result.error}</div>
                                </div>
                            `;
                        }
                    }).join('')}
                </div>
                <div class="results">è¯¦ç»†æ•°æ®: ${JSON.stringify(results, null, 2)}</div>
            `;
            
            resultsDiv.appendChild(editorDiv);
        }

        // æ˜¾ç¤ºæœ€ç»ˆå¯¹æ¯”ç»“æœ
        function displayFinalResults() {
            const finalDiv = document.getElementById('overall-results');
            finalDiv.style.display = 'block';
            
            // ç”Ÿæˆå¯¹æ¯”è¡¨æ ¼
            const successfulEditors = Object.entries(allResults).filter(([name, data]) => 
                Object.values(data).some(test => test.success)
            );
            
            if (successfulEditors.length === 0) {
                finalDiv.innerHTML = '<h2>âŒ æ‰€æœ‰æµ‹è¯•éƒ½å¤±è´¥äº†</h2>';
                return;
            }
            
            let tableHTML = `
                <h2>ğŸ† æœ€ç»ˆæ€§èƒ½å¯¹æ¯”ç»“æœ</h2>
                <table>
                    <tr>
                        <th>ç¼–è¾‘å™¨</th>
                        <th>å°æ–‡æ¡£æ€»æ—¶é—´(ms)</th>
                        <th>ä¸­æ–‡æ¡£æ€»æ—¶é—´(ms)</th>
                        <th>å¤§æ–‡æ¡£æ€»æ—¶é—´(ms)</th>
                        <th>å¤§æ–‡æ¡£å†…å­˜(MB)</th>
                        <th>ç»¼åˆè¯„åˆ†</th>
                    </tr>
            `;
            
            // è®¡ç®—ç»¼åˆè¯„åˆ†å¹¶æ’åº
            const rankings = successfulEditors.map(([name, data]) => {
                const small = data.small?.totalTime || 999999;
                const medium = data.medium?.totalTime || 999999;
                const large = data.large?.totalTime || 999999;
                const memory = data.large?.memoryUsed || 999;
                
                // ç»¼åˆè¯„åˆ†ï¼šæ—¶é—´è¶ŠçŸ­è¶Šå¥½ï¼Œå†…å­˜è¶Šå°‘è¶Šå¥½
                const score = (small * 0.2 + medium * 0.3 + large * 0.5) + memory * 10;
                
                return {
                    name,
                    small: data.small?.success ? small : 'ERROR',
                    medium: data.medium?.success ? medium : 'ERROR', 
                    large: data.large?.success ? large : 'ERROR',
                    memory: data.large?.success ? memory : 'ERROR',
                    score
                };
            }).sort((a, b) => a.score - b.score);
            
            rankings.forEach((item, index) => {
                const isWinner = index === 0;
                tableHTML += `
                    <tr class="${isWinner ? 'winner' : ''}">
                        <td>${isWinner ? 'ğŸ¥‡ ' : ''}${item.name}</td>
                        <td>${item.small}</td>
                        <td>${item.medium}</td>
                        <td>${item.large}</td>
                        <td>${item.memory}</td>
                        <td>${Math.round(item.score)}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</table>';
            
            // æ·»åŠ è¯¦ç»†åˆ†æ
            tableHTML += `
                <h3>ğŸ“Š æ€§èƒ½åˆ†æ</h3>
                <div class="results">
æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString()}
æµ‹è¯•ç¯å¢ƒ: ${navigator.userAgent}

æ€§èƒ½æ’å (åŸºäºç»¼åˆè¯„åˆ†):
${rankings.map((item, index) => 
    `${index + 1}. ${item.name} - è¯„åˆ†: ${Math.round(item.score)}`
).join('\n')}

æµ‹è¯•è¯´æ˜:
â€¢ åŠ è½½æ—¶é—´: JS/CSSèµ„æºä¸‹è½½å’Œè§£ææ—¶é—´
â€¢ åˆå§‹åŒ–æ—¶é—´: ç¼–è¾‘å™¨å®ä¾‹åˆ›å»ºæ—¶é—´  
â€¢ æ¸²æŸ“æ—¶é—´: Markdownå†…å®¹è§£æå’ŒDOMæ¸²æŸ“æ—¶é—´
â€¢ æ€»æ—¶é—´: ä»å¼€å§‹åˆ°ç¼–è¾‘å™¨å®Œå…¨å¯ç”¨çš„æ—¶é—´
â€¢ å†…å­˜å ç”¨: JavaScriptå †å†…å­˜ä½¿ç”¨é‡
â€¢ ç»¼åˆè¯„åˆ†: åŸºäºæ—¶é—´å’Œå†…å­˜çš„åŠ æƒè¯„åˆ†ï¼Œè¶Šä½è¶Šå¥½

åŸå§‹æ•°æ®:
${JSON.stringify(allResults, null, 2)}
                </div>
            `;
            
            finalDiv.innerHTML = tableHTML;
        }

        // å¼€å§‹æ‰€æœ‰æµ‹è¯•
        async function startAllTests() {
            allResults = {};
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('overall-results').style.display = 'none';
            
            updateStatus('å¼€å§‹æ€§èƒ½æµ‹è¯•...', 'running');
            
            for (const editor of editors) {
                const editorResults = {};
                
                for (const [size, content] of Object.entries(testContent)) {
                    const result = await testEditor(editor, size, content);
                    editorResults[size] = result;
                    
                    // æ¯æ¬¡æµ‹è¯•åç­‰å¾…ä¸€ä¸‹ï¼Œé¿å…èµ„æºå†²çª
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                allResults[editor.name] = editorResults;
                displayEditorResult(editor.name, editorResults);
            }
            
            displayFinalResults();
            updateStatus('ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'success');
        }

        // æ¸…ç©ºç»“æœ
        function clearResults() {
            allResults = {};
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('overall-results').style.display = 'none';
            updateStatus('ç»“æœå·²æ¸…ç©º', 'success');
        }

        // å¯¼å‡ºç»“æœ
        function exportResults() {
            if (Object.keys(allResults).length === 0) {
                alert('æ²¡æœ‰æµ‹è¯•ç»“æœå¯å¯¼å‡º');
                return;
            }
            
            const report = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                methodology: "HTMLé¡µé¢ç›´æ¥æµ‹è¯•çœŸå®æµè§ˆå™¨æ€§èƒ½",
                testContent: {
                    small: testContent.small.length + " å­—ç¬¦",
                    medium: testContent.medium.length + " å­—ç¬¦",
                    large: testContent.large.length + " å­—ç¬¦"
                },
                results: allResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `markdown-editor-performance-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºå‡†å¤‡çŠ¶æ€
        window.addEventListener('load', function() {
            updateStatus('å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹å®Œæ•´æµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•', 'success');
        });
    </script>
</body>
</html> 